<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JARVIS</title>
  <style>
    /* HARD FIX: make everything clickable even if some drag-region existed */
    *{ -webkit-app-region: no-drag !important; }

    body{
      margin:0;font-family:system-ui,Segoe UI,Arial;background:#0b0b0f;color:#eaeaf2;
      -webkit-user-select:text; user-select:text;
    }
    header{
      display:flex;align-items:center;gap:12px;padding:12px 14px;
      border-bottom:1px solid #1f1f2a;background:#0f0f15;position:sticky;top:0;z-index:2
    }
    .logo{width:10px;height:10px;border-radius:2px;background:#d40000;box-shadow:0 0 0 2px #111}
    .title{font-weight:700;letter-spacing:.5px}
    .pill{margin-left:auto;font-size:12px;padding:6px 10px;border:1px solid #2a2a3a;border-radius:999px;background:#12121a;color:#cfcfe6}

    .wrap{display:grid;grid-template-columns:220px 1fr;height:calc(100vh - 52px)}
    nav{border-right:1px solid #1f1f2a;background:#0f0f15;padding:10px;overflow:auto}
    .tab{
      display:block;width:100%;text-align:left;padding:10px 10px;margin:6px 0;border-radius:10px;border:1px solid transparent;
      background:transparent;color:#d9d9ee;cursor:pointer;position:relative
    }
    .tab.active{background:#141420;border-color:#2a2a3a}

    main{padding:14px;overflow:hidden}
    .panel{display:none}
    .panel.active{display:block;height:100%}

    .card{border:1px solid #1f1f2a;background:#0f0f15;border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    textarea,input{
      width:100%;box-sizing:border-box;background:#0b0b0f;color:#eaeaf2;border:1px solid #2a2a3a;border-radius:12px;padding:10px;
      -webkit-user-select:text; user-select:text;
    }
    textarea{min-height:90px;resize:vertical}
    .btn{
      padding:10px 12px;border-radius:12px;border:1px solid #2a2a3a;background:#141420;color:#eaeaf2;
      cursor:pointer;position:relative
    }
    .btn.red{background:#2a0000;border-color:#d40000}
    .btn.green{background:#002a10;border-color:#00c26a}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .sectionTitle{font-weight:700;margin:0 0 10px 0}
    .muted{color:#a8a8c2;font-size:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

    /* ---- Console layout ---- */
    #panel-console{display:flex;flex-direction:column;gap:10px;min-height:0;height:100%}
    .consoleGrid{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,3.6fr);
      gap:12px;align-items:stretch;min-height:0;flex:1;
    }
    .consoleGrid > .card{min-width:0;min-height:0}

    .diagCard{display:flex;flex-direction:column;min-height:0}
    .box{
      height:140px;overflow:auto;background:#0b0b0f;border:1px solid #2a2a3a;border-radius:12px;padding:10px;
      min-width:0;overflow-wrap:anywhere;word-break:break-word;
    }
    #chat{flex:1;height:auto;min-height:200px}
    .logLine{white-space:pre-wrap;margin:6px 0;color:#d6d6ee;overflow-wrap:anywhere;word-break:break-word}
    .logLine.dim{color:#9ea0c2}

    /* WhatsApp-style chat */
    .waCard{display:flex;flex-direction:column;min-height:0;height:100%;min-width:0}
    .waHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;min-width:0}
    .waTitle{font-weight:700;white-space:nowrap}
    .waTools{display:flex;gap:10px;align-items:center;justify-content:flex-end;min-width:0;flex-wrap:wrap}
    .chatFind{
      width:260px;height:36px;padding:8px 10px;border-radius:12px;background:#0b0b0f;color:#eaeaf2;border:1px solid #2a2a3a;
      font-size:12px;min-width:180px;box-sizing:border-box;
    }
    .waBody{
      flex:1;overflow:auto;background:#0b0b0f;border:1px solid #2a2a3a;border-radius:12px;padding:10px;
      display:flex;flex-direction:column;min-width:0;min-height:0;
    }
    .waMsg{
      max-width:72%;padding:10px 12px;border-radius:16px;margin:6px 0;white-space:pre-wrap;line-height:1.25;
      overflow-wrap:anywhere;word-break:break-word;cursor:pointer;
    }
    .waMsg.you{margin-left:auto;background:rgba(0,40,255,.18);border:1px solid rgba(0,140,255,.65);box-shadow:0 0 12px rgba(0,140,255,.20);color:#eaf0ff;}
    .waMsg.jarvis{margin-right:auto;background:rgba(0,255,140,.12);border:1px solid rgba(0,255,140,.65);box-shadow:0 0 12px rgba(0,255,140,.18);color:#eafff4;}
    .waMsg.hit{outline:1px dashed rgba(240,180,0,.75);outline-offset:2px}
    .waMsg.hitActive{outline:2px solid rgba(240,180,0,.95);outline-offset:2px}

    .waInputBar{display:grid;grid-template-columns:44px 1fr 140px;gap:10px;margin-top:10px;align-items:end;min-width:0}
    .waInput{min-height:44px;height:44px;max-height:120px;resize:none;border-radius:14px;min-width:0;overflow-wrap:anywhere;word-break:break-word;}
    .micBtn{
      width:44px;height:44px;border-radius:14px;display:inline-flex;align-items:center;justify-content:center;
      border:1px solid #2a2a3a;background:#141420;color:#eaeaf2;cursor:pointer;position:relative;
    }

    /* Bottom bars */
    .dockWrap{flex:0 0 auto;display:flex;flex-direction:column;gap:8px;min-height:0}
    .dockBar{
      border:1px solid #2a2a3a;background:#0f0f15;border-radius:12px;padding:8px 10px;
      display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center;
      box-shadow:0 6px 18px rgba(0,0,0,.18);
    }
    .dockTitle{font-size:12px;color:#a8a8c2}
    .dockText{
      font-size:12px;line-height:1.25;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
      white-space:normal;overflow-wrap:anywhere;word-break:break-word;min-height:2.5em;
    }
    .kpiInline{display:flex;gap:10px;align-items:center;font-size:12px;color:#d9d9ee}
    .dot{width:8px;height:8px;border-radius:999px;background:#666}
    .dot.run{background:#00c26a}
    .dot.pause{background:#f0b400}
    .dot.stop{background:#d40000}

    /* Info tooltip ‚Äúi‚Äù */
    .infoI{
      position:absolute;right:6px;top:4px;width:14px;height:14px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;user-select:none;
      border:1px solid currentColor;color:currentColor;background:transparent;
      opacity:0;transition:opacity .12s ease;pointer-events:auto;
    }
    .tab:hover .infoI, .btn:hover .infoI, .micBtn:hover .infoI{opacity:.20}
    .infoI:hover{opacity:.90}

    #tipBox{
      position:fixed;z-index:999999;max-width:420px;border-radius:10px;border:1px solid #2a2a3a;
      background:rgba(0,0,0,.88);color:#fff;display:none;padding:10px;box-shadow:0 14px 44px rgba(0,0,0,.55);
    }
    #tipBox .tipTitle{font-weight:700;font-size:12px;margin:0 0 8px 0;opacity:.95}
    #tipBox .tipText{font-size:12px;line-height:1.25;white-space:pre-wrap;overflow-wrap:anywhere}

    /* Modal (Rules/Prompt/Storage/API Key/Memoria/Projects/Info) */
    #modalBackdrop{
      position:fixed;inset:0;z-index:999997;background:rgba(0,0,0,.55);display:none;
    }
    #modalBox{
      position:fixed;z-index:999998;left:50%;top:50%;transform:translate(-50%,-50%);
      width:min(760px, calc(100vw - 24px));
      background:#0f0f15;border:1px solid #2a2a3a;border-radius:14px;
      box-shadow:0 16px 60px rgba(0,0,0,.65);padding:12px;display:none;
    }
    .modalHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .modalTitle{font-weight:700}
    .modalBody{display:flex;flex-direction:column;gap:10px;max-height:70vh;overflow:auto}
    .modalActions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    .projBox{border:1px solid #2a2a3a;border-radius:12px;background:#0b0b0f;padding:10px}
    .projRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .projList{display:flex;flex-direction:column;gap:8px;max-height:320px;overflow:auto}
    .projLine{display:flex;gap:8px;align-items:center}
    .projItem{
      width:100%;text-align:left;padding:10px 12px;border-radius:12px;border:1px solid #2a2a3a;background:#141420;color:#eaeaf2;
      cursor:pointer;position:relative;flex:1;min-width:0;overflow-wrap:anywhere;word-break:break-word;
    }
    .projItem.active{border-color:#00c26a}
    .projMini{
      padding:8px 10px;border-radius:12px;border:1px solid #2a2a3a;background:#0f0f15;color:#eaeaf2;
      cursor:pointer;white-space:nowrap;flex:0 0 auto;
    }
    .projMini.red{background:#2a0000;border-color:#d40000}
    .projMini.green{background:#002a10;border-color:#00c26a}

    .dropZone{
      border:1px dashed #2a2a3a;border-radius:12px;padding:12px;background:#0b0b0f;color:#a8a8c2;
    }
    .dropZone.drag{border-color:#00c26a;color:#eafff4}
    .hashList{display:flex;flex-direction:column;gap:6px;max-height:180px;overflow:auto}
    .hashRow{display:flex;gap:10px;align-items:flex-start}
    .hashName{flex:1;min-width:0;overflow-wrap:anywhere;word-break:break-word;font-size:12px}
    .hashVal{font-size:12px;color:#a8a8c2;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;overflow-wrap:anywhere;word-break:break-word}

    .hint{font-size:12px;color:#a8a8c2}

    @media(max-width:1100px){ .consoleGrid{grid-template-columns:1fr} }
    @media(max-width:980px){
      .wrap{grid-template-columns:1fr}
      nav{border-right:0;border-bottom:1px solid #1f1f2a}
      main{overflow:auto}
      .chatFind{width:100%}
    }
  </style>
</head>
<body>
  <header>
    <div class="logo"></div>
    <div class="title">JARVIS</div>
    <button class="btn" id="btnProjects" aria-label="Progetti">PROGETTI</button>
    <div class="pill" id="statusPill">STANDBY</div>
  </header>

  <div class="wrap">
    <nav>
      <button class="tab active" data-tab="console">Console / Chat</button>
      <button class="tab" data-tab="apikey">API Key</button>
      <button class="tab" data-tab="rules">Rules</button>
      <button class="tab" data-tab="prompt">Prompt</button>
      <button class="tab" data-tab="storage">Storage</button>
      <button class="tab" data-tab="memory">Learning / Memoria</button>
    </nav>

    <main>
      <section class="panel active" id="panel-console">
        <div class="consoleGrid">
          <div class="card diagCard">
            <h3 class="sectionTitle">Diagnostics</h3>
            <div class="muted" style="margin:0 0 6px 0">Chat logs</div>
            <div class="box" id="chat"></div>

            <!-- hidden full buffers + cfg fields -->
            <div style="display:none">
              <div id="stepsFull"></div>
              <div id="reportFull"></div>
              <input id="apiKey" />
              <textarea id="rulesText"></textarea>
              <textarea id="promptText"></textarea>
              <input id="p1" /><input id="p2" /><input id="p3" />
              <textarea id="memoryText"></textarea>
            </div>
          </div>

          <div class="card waCard">
            <div class="waHeader">
              <div class="waTitle">Chat</div>
              <div class="waTools">
                <input id="chatFind" class="chatFind" placeholder="Cerca nella chat (Enter = next)..." />
                <button class="btn" id="btnFindPrev" aria-label="Find prev">‚óÄ</button>
                <button class="btn" id="btnFindNext" aria-label="Find next">‚ñ∂</button>
                <button class="btn" id="btnPause">PAUSE</button>
                <button class="btn red" id="btnStop">STOP</button>
              </div>
            </div>

            <div class="waBody" id="waChat"></div>

            <div class="waInputBar">
              <button class="micBtn" id="btnMic" aria-label="Mic" title="Voice (coming soon)">üé§</button>
              <textarea id="taskText" class="waInput" placeholder="Scrivi qui il messaggio... (Enter invia, Shift+Enter va a capo)"></textarea>
              <button class="btn green" id="btnStart">START JARVIS</button>
            </div>

            <div class="muted" style="margin-top:8px">
              Tip: Enter = invia ‚Ä¢ Shift+Enter = nuova riga ‚Ä¢ Click su messaggio = copia testo
            </div>
          </div>
        </div>

        <div class="dockWrap">
          <div class="dockBar">
            <div class="dockTitle">STATE</div>
            <div class="kpiInline">
              <span class="dot" id="dot"></span>
              <span id="stateText">Standby</span>
            </div>
          </div>
          <div class="dockBar">
            <div class="dockTitle">Last steps</div>
            <div class="dockText mono" id="stepsDock"></div>
          </div>
          <div class="dockBar">
            <div class="dockTitle">STOP report (last)</div>
            <div class="dockText mono" id="reportDock"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="tipBox"></div>

  <div id="modalBackdrop"></div>
  <div id="modalBox">
    <div class="modalHead">
      <div class="modalTitle" id="modalTitle">TITLE</div>
      <button class="btn" id="modalClose" aria-label="Chiudi">Chiudi</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
    <div class="modalActions">
      <button class="btn green" id="modalSave">Salva</button>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // Kill any prompt() errors forever (Electron sometimes disables it)
    try { window.prompt = () => null; } catch(_) {}

    // ---- Diagnostics log helper
    const addLogLine = (text, dim=false) => {
      const d = document.createElement("div");
      d.className = "logLine" + (dim ? " dim" : "");
      d.textContent = text;
      $("chat").appendChild(d);
      $("chat").scrollTop = $("chat").scrollHeight;
    };
    const pushDiag = (line) => {
      const c = $("chat");
      addLogLine(line, true);
      while (c.childNodes.length > 220) c.removeChild(c.firstChild);
    };

    // Surface UI errors
    window.addEventListener("error", (e) => { pushDiag("UI_ERROR: " + (e && e.message ? e.message : "unknown")); });
    window.addEventListener("unhandledrejection", (e) => {
      const r = e && e.reason ? (e.reason.message || String(e.reason)) : "unknown";
      pushDiag("UI_REJECT: " + r);
    });

    // Local storage
    const LS = {
      k: "jarvis_v1_cfg",
      load() { try { return JSON.parse(localStorage.getItem(this.k) || "{}"); } catch { return {}; } },
      save(obj) { localStorage.setItem(this.k, JSON.stringify(obj || {})); }
    };
    const CHAT_K = "jarvis_v1_chat_hist";

    const cfg = LS.load();
    // Security: API key is NOT stored in localStorage. If legacy key exists, purge it.
    try { if (cfg.apiKey) { delete cfg.apiKey; LS.save(cfg); pushDiag("APIKEY_PURGED_LOCALSTORAGE"); } } catch (_) {}

    cfg.tips = cfg.tips || {};
    cfg.projects = Array.isArray(cfg.projects) ? cfg.projects : [];
    cfg.activeProjectId = cfg.activeProjectId || "";
    cfg.lastSelectedText = cfg.lastSelectedText || "";

    // Populate hidden fields (storage)
    $("apiKey").value = "";
    $("rulesText").value = cfg.rulesText || "AGGRESSIVO MA ONESTO.\n- Non invento.\n- Se non posso: mi fermo e lo dico.\n- Se serve autorizzazione/rischio: chiedo prima.\n- Popup OS/UAC: attendo conferma, non bypass.";
    $("promptText").value = cfg.promptText || "";
    $("p1").value = cfg.p1 || "";
    $("p2").value = cfg.p2 || "";
    $("p3").value = cfg.p3 || "";
    $("memoryText").value = cfg.memoryText || "";

    // State
    const setState = (s) => {
      const pill = $("statusPill");
      const dot = $("dot");
      let label = "STANDBY";
      dot.className = "dot";
      if (s && s.running) { label = s.paused ? "PAUSED" : "RUNNING"; dot.classList.add(s.paused ? "pause" : "run"); }
      pill.textContent = label;
      $("stateText").textContent = label;
      try { $("btnStart").disabled = !!(s && s.running); } catch {}
    };
    const hasJarvis = () => window.jarvis && typeof window.jarvis.start === "function";

    // Active project helper
    const getActiveProject = () => cfg.projects.find(p => p && p.id === cfg.activeProjectId) || null;

    // SHA-256 helpers (WebCrypto)
    const hasCrypto = () => !!(window.crypto && window.crypto.subtle && window.crypto.subtle.digest);
    const bufToHex = (buf) => Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
    const sha256Bytes = async (bytes) => {
      if (!hasCrypto()) throw new Error("crypto.subtle not available");
      const h = await crypto.subtle.digest("SHA-256", bytes);
      return bufToHex(h);
    };
    const sha256Text = async (s) => sha256Bytes(new TextEncoder().encode(String(s || "")));

    // Last steps + report dock
    const addStep = (text) => {
      const full = $("stepsFull");
      const d = document.createElement("div");
      d.textContent = text;
      full.appendChild(d);
      while (full.childNodes.length > 120) full.removeChild(full.firstChild);
      const last2 = Array.from(full.childNodes).slice(-2).map(n => n.textContent);
      $("stepsDock").textContent = last2.join("\n");
    };
    const setReport = (reportText) => {
      $("reportFull").textContent = String(reportText || "");
      const lines = String(reportText || "").split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      $("reportDock").textContent = lines.slice(-2).join("\n");
    };

    // Chat bubbles
    const addBubble = (who, text) => {
      const d = document.createElement("div");
      d.className = "waMsg " + who;
      d.textContent = text;

      d.addEventListener("click", async () => {
        const t = d.textContent || "";
        cfg.lastSelectedText = t;
        LS.save(cfg);
        try { await navigator.clipboard.writeText(t); pushDiag("COPIED_CHAT_TEXT (saved in cfg.lastSelectedText)"); }
        catch { pushDiag("COPIED_CHAT_TEXT (clipboard blocked, but saved in cfg.lastSelectedText)"); }
      });

      $("waChat").appendChild(d);
      $("waChat").scrollTop = $("waChat").scrollHeight;
    };

    const loadChatHist = () => { try { return JSON.parse(localStorage.getItem(CHAT_K) || "[]"); } catch { return []; } };
    const saveChatHist = (arr) => { try { localStorage.setItem(CHAT_K, JSON.stringify((arr||[]).slice(-60))); } catch {} };
    let hist = loadChatHist();

    const renderHist = () => {
      $("waChat").textContent = "";
      for (const m of hist) {
        if (!m || !m.role || typeof m.content !== "string") continue;
        addBubble(m.role === "assistant" ? "jarvis" : "you", m.content);
      }
    };
    renderHist();

    // ----------------- Modal engine -----------------
    const modalBackdrop = $("modalBackdrop");
    const modalBox = $("modalBox");
    const modalTitle = $("modalTitle");
    const modalBody = $("modalBody");
    const modalSave = $("modalSave");
    const modalClose = $("modalClose");

    let modalKind = "";

    // Info modal pending
    let infoPendingKey = "";
    let infoPendingLabel = "";
    let infoPendingDefault = "";

    // Projects modal state
    let projView = "list"; // list | notes
    let projEditId = "";
    let projDelArmId = "";
    let projDelArmUntil = 0;

    const closeModal = () => {
      modalKind = "";
      modalBody.innerHTML = "";
      modalBackdrop.style.display = "none";
      modalBox.style.display = "none";
      modalSave.textContent = "Salva";
      modalSave.style.display = "inline-flex";
    };

    const mk = (tag, props={}) => {
      const el = document.createElement(tag);
      Object.entries(props).forEach(([k,v]) => {
        if (k === "text") el.textContent = v;
        else if (k === "html") el.innerHTML = v;
        else el.setAttribute(k, v);
      });
      return el;
    };

    const normalizeProjects = () => {
      cfg.projects = (cfg.projects || []).filter(p => p && p.id && p.name);
      cfg.projects.forEach(p => {
        if (!p.notes) p.notes = "";
        if (!Array.isArray(p.artifacts)) p.artifacts = [];
        if (!p.createdAt) p.createdAt = Date.now();
        if (!p.hash) p.hash = "";
      });
      if (cfg.activeProjectId && !cfg.projects.find(p => p.id === cfg.activeProjectId)) cfg.activeProjectId = "";
    };

    const getProjectById = (id) => cfg.projects.find(p => p && p.id === id) || null;

    const renderProjectNotesView = (p) => {
      modalBody.innerHTML = "";

      const box = mk("div", { class:"projBox" });
      box.appendChild(mk("div", { class:"muted", text: "INFO PROGETTO" }));

      const head = mk("div", { class:"hint", text:
        `${p.name}${p.root ? (" ‚Äî " + p.root) : ""}${p.hash ? ("  |  hash: " + p.hash.slice(0,12) + "...") : ""}`
      });
      box.appendChild(head);

      const ta = mk("textarea", { id:"projNotes", placeholder:"Scrivi qui le note del progetto..." });
      ta.value = String(p.notes || "");

      const row = mk("div", { class:"projRow", style:"margin-top:8px;justify-content:flex-end" });
      const back = mk("button", { class:"btn", text:"BACK" });
      const save = mk("button", { class:"btn green", text:"SALVA NOTE" });

      back.onclick = () => {
        projView = "list";
        projEditId = "";
        renderProjectsModal();
      };
      save.onclick = () => {
        p.notes = String(ta.value || "");
        LS.save(cfg);
        pushDiag("PROJECT_NOTES_SAVED: " + p.name);
      };

      row.appendChild(back);
      row.appendChild(save);

      box.appendChild(ta);
      box.appendChild(row);
      modalBody.appendChild(box);

      setTimeout(() => { try{ ta.focus(); }catch(_){} }, 0);
    };

    const renderProjectsModal = () => {
      normalizeProjects();

      if (projView === "notes") {
        const p = getProjectById(projEditId);
        if (!p) { projView = "list"; projEditId = ""; }
        else { modalTitle.textContent = "PROGETTI ‚Äî INFO"; renderProjectNotesView(p); applyInfoToAll(); return; }
      }

      modalTitle.textContent = "PROGETTI";
      modalBody.innerHTML = "";

      const ap = getActiveProject();

      // Top: active + clear active
      const top = mk("div", { class:"projBox" });
      top.appendChild(mk("div", { class:"muted", text: ap ? ("Attivo: " + ap.name + (ap.root ? (" ‚Äî " + ap.root) : "")) : "Attivo: (nessuno)" }));
      if (ap && ap.hash) top.appendChild(mk("div", { class:"hint", text: "project_hash: " + ap.hash }));

      const row = mk("div", { class:"projRow", style:"margin-top:8px" });

      const btnClearActive = mk("button", { class:"btn", id:"btnClearActive", text:"CLEAR ACTIVE" });
      btnClearActive.onclick = () => {
        cfg.activeProjectId = "";
        LS.save(cfg);
        pushDiag("PROJECT_CLEAR_ACTIVE");
        renderProjectsModal();
      };

      row.appendChild(btnClearActive);
      top.appendChild(row);
      modalBody.appendChild(top);

      // Active project: hash files
      const vault = mk("div", { class:"projBox" });
      vault.appendChild(mk("div", { class:"muted", text:"FILE ‚Üí SHA-256 (solo progetto attivo)" }));

      if (!ap) {
        vault.appendChild(mk("div", { class:"hint", text:"Seleziona un progetto per usare Carica/Drag&Drop." }));
      } else {
        const actRow = mk("div", { class:"projRow", style:"margin-top:8px" });

        const fileInput = mk("input", { id:"projFilePick", type:"file", multiple:"true", style:"display:none" });
        const btnPick = mk("button", { class:"btn green", text:"CARICA FILE" });
        btnPick.onclick = () => fileInput.click();

        const handleFiles = async (files) => {
          try {
            if (!files || !files.length) return;
            if (!hasCrypto()) { pushDiag("HASH_FAIL: crypto.subtle not available"); return; }

            for (const f of Array.from(files)) {
              const ab = await f.arrayBuffer();
              const sha = await sha256Bytes(new Uint8Array(ab));
              const rec = {
                ts: Date.now(),
                name: f.name || "file",
                size: f.size || 0,
                type: f.type || "",
                lastModified: f.lastModified || 0,
                sha256: sha
              };
              ap.artifacts = Array.isArray(ap.artifacts) ? ap.artifacts : [];
              ap.artifacts.unshift(rec);
              ap.artifacts = ap.artifacts.slice(0, 120);
              LS.save(cfg);
              pushDiag("FILE_HASHED: " + rec.name + " | " + rec.sha256.slice(0,12) + "...");

              // Optional: if Electron bridge exists later, we can also persist to disk.
              try {
                if (window.jarvis && typeof window.jarvis.saveProjectHashRecord === "function") {
                  await window.jarvis.saveProjectHashRecord({ projectId: ap.id, projectHash: ap.hash || "", record: rec });
                  pushDiag("DISK_SAVE: ok");
                }
              } catch (_) {
                // keep silent; UI still works with localStorage
              }
            }
            renderProjectsModal();
          } catch (e) {
            pushDiag("HASH_FAIL: " + (e && e.message ? e.message : "FAILED"));
          }
        };

        fileInput.onchange = () => handleFiles(fileInput.files);

        const dz = mk("div", { class:"dropZone", id:"dropZone", text:"Drag&Drop file qui (SHA-256 automatico)" });
        dz.addEventListener("dragover", (e) => { e.preventDefault(); dz.classList.add("drag"); });
        dz.addEventListener("dragleave", () => dz.classList.remove("drag"));
        dz.addEventListener("drop", (e) => {
          e.preventDefault();
          dz.classList.remove("drag");
          const files = e.dataTransfer && e.dataTransfer.files ? e.dataTransfer.files : null;
          handleFiles(files);
        });

        actRow.appendChild(btnPick);
        actRow.appendChild(fileInput);
        vault.appendChild(actRow);
        vault.appendChild(dz);

        const list = mk("div", { class:"hashList", style:"margin-top:10px" });
        const items = (ap.artifacts || []).slice(0, 25);

        if (!items.length) {
          list.appendChild(mk("div", { class:"hint", text:"Nessun file ancora." }));
        } else {
          items.forEach(rec => {
            const hr = mk("div", { class:"hashRow" });
            const name = mk("div", { class:"hashName", text: rec.name });
            const val = mk("div", { class:"hashVal", text: rec.sha256 });

            const copy = mk("button", { class:"projMini", text:"COPY" });
            copy.onclick = async () => {
              try { await navigator.clipboard.writeText(rec.sha256); pushDiag("HASH_COPIED"); }
              catch { pushDiag("HASH_COPIED (clipboard blocked)"); }
            };

            hr.appendChild(name);
            hr.appendChild(copy);
            hr.appendChild(val);
            list.appendChild(hr);
          });
        }
        vault.appendChild(list);
      }

      modalBody.appendChild(vault);

      // New project form
      const form = mk("div", { class:"projBox" });
      form.appendChild(mk("div", { class:"muted", text:"NUOVO PROGETTO" }));

      const inName = mk("input", { id:"projName", placeholder:"Nome progetto (obbligatorio)..." });
      const inRoot = mk("input", { id:"projRoot", placeholder:"Root path (opzionale)..." });
      const hint = mk("div", { class:"hint", text:"Salva: il progetto appare qui sotto e diventa attivo." });

      const btnSaveProj = mk("button", { class:"btn green", id:"btnSaveProj", text:"SALVA PROGETTO" });
      btnSaveProj.onclick = async () => {
        const name = String(inName.value || "").trim();
        const root = String(inRoot.value || "").trim();
        if (!name) { pushDiag("PROJECT_ADD_FAIL: missing name"); return; }

        const createdAt = Date.now();
        const id = "P_" + createdAt;
        let ph = "";
        try {
          if (hasCrypto()) {
            const manifest = `id=${id}\nname=${name}\nroot=${root}\ncreatedAt=${createdAt}`;
            ph = await sha256Text(manifest);
          }
        } catch (_) {}

        cfg.projects.push({ id, name, root, createdAt, hash: ph, notes:"", artifacts: [] });
        cfg.activeProjectId = id;
        LS.save(cfg);
        pushDiag("PROJECT_ADDED: " + name + (ph ? (" | hash=" + ph.slice(0,12) + "...") : ""));
        renderProjectsModal();
      };

      form.appendChild(inName);
      form.appendChild(inRoot);
      form.appendChild(hint);
      form.appendChild(btnSaveProj);
      modalBody.appendChild(form);

      // Projects list
      const listBox = mk("div", { class:"projBox" });
      listBox.appendChild(mk("div", { class:"muted", text:"PROGETTI SALVATI" }));

      const list = mk("div", { class:"projList" });

      if (!cfg.projects.length) {
        list.appendChild(mk("div", { class:"muted", text:"Nessun progetto salvato." }));
      } else {
        cfg.projects.forEach(p => {
          const line = mk("div", { class:"projLine" });

          const b = mk("button", { class:"projItem" + (p.id === cfg.activeProjectId ? " active" : ""), "aria-label":"Progetto: " + p.name });
          b.textContent = p.name + (p.root ? ("  ‚Äî  " + p.root) : "") + (p.hash ? ("  |  " + p.hash.slice(0,10) + "...") : "");
          b.onclick = () => {
            cfg.activeProjectId = p.id;
            LS.save(cfg);
            pushDiag("PROJECT_SET_ACTIVE: " + p.name);
            renderProjectsModal();
          };

          const info = mk("button", { class:"projMini", text:"i" });
          info.onclick = () => {
            projView = "notes";
            projEditId = p.id;
            renderProjectsModal();
          };

          const armed = (projDelArmId === p.id && Date.now() < projDelArmUntil);
          const del = mk("button", { class:"projMini red", text: armed ? "CONFIRM" : "CLEAR" });
          del.onclick = () => {
            const now = Date.now();
            if (!(projDelArmId === p.id && now < projDelArmUntil)) {
              projDelArmId = p.id;
              projDelArmUntil = now + 5000; // 5s confirm window
              pushDiag("PROJECT_CLEAR_ARMED: " + p.name + " (click CONFIRM)");
              renderProjectsModal();
              return;
            }

            // confirmed
            cfg.projects = cfg.projects.filter(x => x && x.id !== p.id);
            if (cfg.activeProjectId === p.id) cfg.activeProjectId = "";
            LS.save(cfg);
            projDelArmId = ""; projDelArmUntil = 0;
            pushDiag("PROJECT_CLEARED: " + p.name);
            renderProjectsModal();
          };

          line.appendChild(b);
          line.appendChild(info);
          line.appendChild(del);
          list.appendChild(line);
        });
      }

      listBox.appendChild(list);
      modalBody.appendChild(listBox);

      applyInfoToAll();
      setTimeout(() => { try{ inName.focus(); }catch(_){} }, 0);
    };

    const openModal = (kind) => {
      modalKind = kind;
      modalBody.innerHTML = "";
      modalBackdrop.style.display = "block";
      modalBox.style.display = "block";
      modalSave.style.display = "inline-flex";
      modalSave.textContent = "Salva";

      if (kind === "projects") {
        projView = "list";
        projEditId = "";
        modalTitle.textContent = "PROGETTI";
        modalSave.textContent = "Chiudi";
        modalSave.style.display = "inline-flex";
        renderProjectsModal();
        applyInfoToAll();
        return;
      }

      if (kind === "infoedit") {
        modalTitle.textContent = "INFO";
        const info = mk("div", { class:"muted", text: infoPendingLabel ? ("Target: " + infoPendingLabel) : "Info" });
        const ta = mk("textarea", { id:"m_info", placeholder:"Scrivi info/nota e salva..." });
        const cur = (cfg.tips[infoPendingKey] && String(cfg.tips[infoPendingKey]).trim())
          ? String(cfg.tips[infoPendingKey]).trim()
          : String(infoPendingDefault || "");
        ta.value = cur;
        modalBody.appendChild(info);
        modalBody.appendChild(ta);
        setTimeout(() => ta.focus(), 50);
        applyInfoToAll();
        return;
      }

      if (kind === "apikey") {
        modalTitle.textContent = "API Key";
        const info = mk("div", { class:"muted", text:"Incolla o scrivi la key, poi Salva." });
        const inp = mk("input", { id:"m_apiKey", placeholder:"Incolla qui la tua API key..." });
        inp.value = $("apiKey").value || "";
        const pasteBtn = mk("button", { class:"btn", id:"m_pasteKey", text:"PASTE" });
        pasteBtn.onclick = async () => {
          try {
            const t = await navigator.clipboard.readText();
            if (t) inp.value = t.trim();
            pushDiag("APIKEY_PASTE_TRY: ok");
          } catch (_) {
            pushDiag("APIKEY_PASTE_TRY: blocked (use Ctrl+V)");
          }
          inp.focus();
        };
        const row = mk("div", { class:"row" });
        row.appendChild(pasteBtn);
        modalBody.appendChild(info);
        modalBody.appendChild(inp);
        modalBody.appendChild(row);
        setTimeout(() => inp.focus(), 50);
      }

      if (kind === "rules") {
        modalTitle.textContent = "Rules (non violabile)";
        const ta = mk("textarea", { id:"m_rules" });
        ta.value = $("rulesText").value || "";
        modalBody.appendChild(ta);
        setTimeout(() => ta.focus(), 50);
      }

      if (kind === "prompt") {
        modalTitle.textContent = "Prompt";
        const ta = mk("textarea", { id:"m_prompt", placeholder:"Template prompt..." });
        ta.value = $("promptText").value || "";
        modalBody.appendChild(ta);
        setTimeout(() => ta.focus(), 50);
      }

      if (kind === "storage") {
        modalTitle.textContent = "Storage (3 path)";
        const i1 = mk("input", { id:"m_p1", placeholder:"Path 1..." }); i1.value = $("p1").value || "";
        const i2 = mk("input", { id:"m_p2", placeholder:"Path 2..." }); i2.value = $("p2").value || "";
        const i3 = mk("input", { id:"m_p3", placeholder:"Path 3..." }); i3.value = $("p3").value || "";
        modalBody.appendChild(i1); modalBody.appendChild(i2); modalBody.appendChild(i3);
        setTimeout(() => i1.focus(), 50);
      }

      if (kind === "memory") {
        modalTitle.textContent = "Learning / Memoria";
        const info = mk("div", { class:"muted", text:"V1: note locali. (In futuro: memoria strutturata + retrieval.)" });
        const ta = mk("textarea", { id:"m_memory", placeholder:"Note e riassunti locali..." });
        ta.value = $("memoryText").value || "";
        modalBody.appendChild(info);
        modalBody.appendChild(ta);
        setTimeout(() => ta.focus(), 50);
      }

      applyInfoToAll();
    };

    modalClose.onclick = closeModal;
    modalBackdrop.onclick = closeModal;
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modalBox.style.display === "block") closeModal();
    });

    modalSave.onclick = async () => {
      if (!modalKind) return;

      if (modalKind === "projects") { closeModal(); return; }

      if (modalKind === "infoedit") {
        const v = (document.getElementById("m_info")?.value || "");
        if (infoPendingKey) {
          cfg.tips[infoPendingKey] = String(v || "").trim();
          LS.save(cfg);
          pushDiag("INFO_SAVED: " + infoPendingKey);
        }
        closeModal();
        return;
      }

      if (modalKind === "apikey") {
        const v = (document.getElementById("m_apiKey")?.value || "").trim();
        $("apiKey").value = v;
        cfg.hasApiKey = !!v;
        LS.save(cfg);
pushDiag("APIKEY_SAVED");
        // Secure store (main process) ‚Äî do not persist key in localStorage
        try {
          if (window.jarvis && typeof window.jarvis.setApiKey === "function") {
            await window.jarvis.setApiKey(v);
            if (typeof window.jarvis.hasApiKey === "function") {
              const has = await window.jarvis.hasApiKey();
              cfg.hasApiKey = !!has;
            } else {
              cfg.hasApiKey = !!v;
            }
            LS.save(cfg);
            pushDiag("APIKEY_SECURE_STORED");
          } else {
            pushDiag("APIKEY_SECURE_STORE_FAIL: jarvis.setApiKey missing");
          }
        } catch (e) {
          pushDiag("APIKEY_SECURE_STORE_FAIL: " + (e && e.message ? e.message : "ERR"));
        }

        closeModal();
        return;
}
      if (modalKind === "rules") {
        const v = (document.getElementById("m_rules")?.value || "");
        $("rulesText").value = v;
        cfg.rulesText = v;
        LS.save(cfg);
        pushDiag("RULES_SAVED");
        closeModal();
        return;
      }
      if (modalKind === "prompt") {
        const v = (document.getElementById("m_prompt")?.value || "");
        $("promptText").value = v;
        cfg.promptText = v;
        LS.save(cfg);
        pushDiag("PROMPT_SAVED");
        closeModal();
        return;
      }
      if (modalKind === "storage") {
        const p1 = (document.getElementById("m_p1")?.value || "");
        const p2 = (document.getElementById("m_p2")?.value || "");
        const p3 = (document.getElementById("m_p3")?.value || "");
        $("p1").value = p1; $("p2").value = p2; $("p3").value = p3;
        cfg.p1 = p1; cfg.p2 = p2; cfg.p3 = p3;
        LS.save(cfg);
        pushDiag("STORAGE_SAVED");
        closeModal();
        return;
      }
      if (modalKind === "memory") {
        const v = (document.getElementById("m_memory")?.value || "");
        $("memoryText").value = v;
        cfg.memoryText = v;
        LS.save(cfg);
        pushDiag("MEMORY_SAVED");
        closeModal();
        return;
      }
    };

    // ----------------- Tooltip system (hover only) -----------------
    const tipBox = $("tipBox");
    let tipTimer = null;

    const tipKeyFor = (el) => {
      if (!el) return "unknown";
      if (el.id) return "id:" + el.id;
      if (el.dataset && el.dataset.tab) return "tab:" + el.dataset.tab;
      const t = (el.getAttribute("aria-label") || el.textContent || "").trim().toLowerCase();
      return "txt:" + t;
    };

    const tipDefaultFor = (el) => {
      const t = (el.getAttribute("data-tip") || el.getAttribute("aria-label") || el.textContent || "").trim().toLowerCase();
      if (t.includes("console")) return "Apri la console + chat.";
      if (t.includes("api key")) return "Apri finestra API Key (salvataggio locale).";
      if (t === "rules") return "Apri finestra Rules (salvataggio locale).";
      if (t.includes("prompt")) return "Apri finestra Prompt (salvataggio locale).";
      if (t.includes("storage")) return "Apri finestra Storage (3 path).";
      if (t.includes("memoria")) return "Apri finestra Memoria (note locali).";
      if (t.includes("start")) return "Invia il messaggio (Enter invia).";
      if (t.includes("pause")) return "Pausa/Resume (V1 non interrompe chiamata API gi√† partita).";
      if (t.includes("stop")) return "STOP: ferma + report.";
      if (t.includes("mic") || t.includes("üé§") || t.includes("voice")) return "Voce (prossimo ramo): pulsante pronto, logica verr√† aggiunta.";
      if (t.includes("progetti")) return "Gestisci progetti (finestra): nuovo, lista, attivo, clear active, hash file.";
      if (t.includes("find")) return "Naviga tra i risultati della ricerca in chat.";
      if (t.includes("chiudi")) return "Chiude la finestra.";
      if (t.includes("salva")) return "Salva il contenuto della finestra.";
      return "Info.";
    };

    const placeTip = (anchorRect) => {
      const pad = 8;
      const w = tipBox.offsetWidth || 360;
      const h = tipBox.offsetHeight || 140;

      let x = anchorRect.left + anchorRect.width + 8;
      if (x + w + pad > window.innerWidth) x = anchorRect.left - w - 8;
      x = Math.max(pad, Math.min(window.innerWidth - w - pad, x));

      let y = anchorRect.top;
      if (y + h + pad > window.innerHeight) y = window.innerHeight - h - pad;
      y = Math.max(pad, Math.min(window.innerHeight - h - pad, y));

      tipBox.style.left = x + "px";
      tipBox.style.top = y + "px";
    };

    const hideTip = () => {
      tipBox.style.display = "none";
      tipBox.style.pointerEvents = "none";
      tipBox.innerHTML = "";
    };

    const showTipHover = (el, anchorRect) => {
      const key = tipKeyFor(el);
      const txt = (cfg.tips[key] && String(cfg.tips[key]).trim()) ? String(cfg.tips[key]).trim() : tipDefaultFor(el);
      tipBox.innerHTML = `<div class="tipTitle">INFO</div><div class="tipText"></div>`;
      tipBox.querySelector(".tipText").textContent = txt;
      tipBox.style.display = "block";
      tipBox.style.pointerEvents = "none";
      placeTip(anchorRect);
    };

    const addInfoI = (btn) => {
      if (!btn || btn.__hasI) return;
      btn.__hasI = true;
      btn.style.position = btn.style.position || "relative";

      const i = document.createElement("span");
      i.className = "infoI";
      i.textContent = "i";

      const attach = () => {
        if (tipTimer) clearTimeout(tipTimer);
        tipTimer = setTimeout(() => showTipHover(btn, i.getBoundingClientRect()), 250);
      };
      const detach = () => {
        if (tipTimer) clearTimeout(tipTimer);
        hideTip();
      };

      i.addEventListener("mouseenter", attach);
      i.addEventListener("mouseleave", detach);
      btn.addEventListener("mouseleave", detach);

      // CLICK -> modal editor (finestra)
      i.addEventListener("click", (e) => {
        e.preventDefault(); e.stopPropagation();
        infoPendingKey = tipKeyFor(btn);
        infoPendingLabel = (btn.getAttribute("aria-label") || btn.textContent || "").trim();
        infoPendingDefault = tipDefaultFor(btn);
        openModal("infoedit");
      });

      btn.appendChild(i);
    };

    const applyInfoToAll = () => {
      [
        $("btnProjects"),
        $("btnFindPrev"), $("btnFindNext"),
        $("btnPause"), $("btnStop"),
        $("btnMic"), $("btnStart"),
        $("modalClose"), $("modalSave"),
      ].filter(Boolean).forEach(addInfoI);
    };

    // ----------------- Tabs: console panel stays, other tabs open modal -----------------
    const setActiveTabUI = (tabName) => {
      document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
      const btn = Array.from(document.querySelectorAll(".tab")).find(x => x.dataset && x.dataset.tab === tabName);
      if (btn) btn.classList.add("active");
    };

    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", (ev) => {
        if (ev && ev.target && ev.target.classList && ev.target.classList.contains("infoI")) return;

        const t = btn.dataset.tab || "console";
        if (t === "console") {
          setActiveTabUI("console");
          document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
          $("panel-console").classList.add("active");
          return;
        }
        setActiveTabUI(t);
        openModal(t);
      });
    });

    // PROGETTI button -> modal
    $("btnProjects").addEventListener("click", (e) => {
      e.preventDefault(); e.stopPropagation();
      openModal("projects");
    });

    // ----------------- Chat find -----------------
    let findHits = [];
    let findIdx = -1;

    const clearHits = () => {
      document.querySelectorAll(".waMsg.hit, .waMsg.hitActive").forEach(el => {
        el.classList.remove("hit"); el.classList.remove("hitActive");
      });
      findHits = []; findIdx = -1;
    };

    const buildHits = (q) => {
      clearHits();
      const qq = String(q || "").trim().toLowerCase();
      if (!qq) return;
      const msgs = Array.from(document.querySelectorAll("#waChat .waMsg"));
      findHits = msgs.filter(m => (m.textContent || "").toLowerCase().includes(qq));
      findHits.forEach(m => m.classList.add("hit"));
      if (findHits.length) { findIdx = 0; focusHit(); }
      pushDiag("FIND: hits=" + findHits.length);
    };

    const focusHit = () => {
      if (!findHits.length) return;
      findHits.forEach(m => m.classList.remove("hitActive"));
      const el = findHits[Math.max(0, Math.min(findHits.length-1, findIdx))];
      el.classList.add("hitActive");
      el.scrollIntoView({ block: "center", behavior: "smooth" });
    };

    const nextHit = () => {
      if (!findHits.length) { buildHits($("chatFind").value); return; }
      findIdx = (findIdx + 1) % findHits.length;
      focusHit();
    };

    const prevHit = () => {
      if (!findHits.length) { buildHits($("chatFind").value); return; }
      findIdx = (findIdx - 1 + findHits.length) % findHits.length;
      focusHit();
    };

    $("chatFind").addEventListener("input", () => buildHits($("chatFind").value));
    $("chatFind").addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); nextHit(); }
    });
    $("btnFindNext").onclick = nextHit;
    $("btnFindPrev").onclick = prevHit;

    // ----------------- Wire jarvis events -----------------
    try {
      if (window.jarvis && typeof window.jarvis.onLog === "function") {
        window.jarvis.onLog((p) => {
          const s = String((p && p.line) ? p.line : "");
          if (!s) return;
          if (/out_sha256=|Write proof JSON|OpenAI call|ERROR|DONE|Answer ready|Answer|UI_/i.test(s)) pushDiag(s);
        });
      }
      if (window.jarvis && typeof window.jarvis.onStep === "function") {
        window.jarvis.onStep((s) => {
          addStep(`${new Date(s.ts).toLocaleTimeString()} :: ${s.title} :: ${s.status}${s.proof ? " | " + s.proof : ""}`);
        });
      }
      if (window.jarvis && typeof window.jarvis.onReport === "function") {
        window.jarvis.onReport((r) => { setReport(r.report || ""); });
      }
      if (window.jarvis && typeof window.jarvis.onState === "function") {
        window.jarvis.onState((s) => setState(s));
      }
      if (window.jarvis && typeof window.jarvis.onAnswer === "function") {
        window.jarvis.onAnswer((p) => {
          const ans = String((p && p.answer) ? p.answer : "").trim();
          if (!ans) return;
          hist.push({ role:"assistant", content: ans, ts: Date.now() });
          saveChatHist(hist);
          addBubble("jarvis", ans);
          buildHits($("chatFind").value);
        });
      }
    } catch (_) {}

    // ----------------- Send now -----------------
    const sendNow = async () => {
      const txt = $("taskText").value.trim();
      if (!txt) return;

      $("stepsFull").textContent = "";
      $("stepsDock").textContent = "";
      $("reportFull").textContent = "";
      $("reportDock").textContent = "";

      hist.push({ role:"user", content: txt, ts: Date.now() });
      saveChatHist(hist);
      addBubble("you", txt);
      buildHits($("chatFind").value);

      if (!hasJarvis()) { pushDiag("UI_ERROR: window.jarvis not available (preload missing)."); return; }

      const apiKey = $("apiKey").value.trim();
      const rulesText = $("rulesText").value || "";
      const toSend = hist.slice(-10).map(m => ({ role: m.role, content: m.content }));

      try {
        const ap = getActiveProject();
        const prefix =
          (ap ? `[ACTIVE_PROJECT] ${ap.name} ${ap.root ? ("| " + ap.root) : ""}\n${ap.hash ? ("[PROJECT_HASH] " + ap.hash + "\n") : ""}` : "") +
          (cfg.lastSelectedText ? `[SELECTED_TEXT]\n${cfg.lastSelectedText}\n\n` : "");
        await window.jarvis.start(prefix + txt, apiKey, toSend, rulesText);
      } catch (e) {
        pushDiag("UI_ERROR start: " + (e && e.message ? e.message : "FAILED"));
      }

      $("taskText").value = "";
      $("taskText").style.height = "44px";
    };

    $("btnStart").onclick = sendNow;

    $("btnPause").onclick = async () => {
      if (!hasJarvis()) return;
      const st = await window.jarvis.state();
      if (!st.running) return;
      if (!st.paused) await window.jarvis.pause();
      else await window.jarvis.resume();
      const st2 = await window.jarvis.state();
      setState(st2);
    };

    $("btnStop").onclick = async () => {
      if (!hasJarvis()) return;
      await window.jarvis.stop("STOP pressed in UI.");
      const st = await window.jarvis.state();
      setState(st);
    };

    $("btnMic").onclick = () => { pushDiag("VOICE: placeholder button. Next branch will implement mic mode."); };

    $("taskText").addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendNow(); }
    });

    $("taskText").addEventListener("input", () => {
      const ta = $("taskText");
      ta.style.height = "44px";
      const h = Math.min(120, ta.scrollHeight);
      ta.style.height = h + "px";
    });

    // Boot
    (async () => {
      applyInfoToAll();
      buildHits($("chatFind").value);

      setActiveTabUI("console");
      document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
      $("panel-console").classList.add("active");

      pushDiag("UI_BOOT: FIX6 (projects clear-per-item + info modal + sha256)");

      if (hasJarvis()) {
        const st = await window.jarvis.state();
        setState(st);
        pushDiag("UI_OK. Ready. Tray is active (PAUSE/STOP).");
      } else {
        pushDiag("UI_WARN: window.jarvis not available. Start via npm start (Electron).");
      }
    })();
  </script>
</body>
</html>
